language: python
addons:
  apt:
    packages:
    - gfortran
python:
  - 2.7
  - 3.5
env:
  - NUMPY=1.7    SCIPY=0.11   NETCDF=1.0   MATPLOTLIB=1.3 BASEMAP=1.0.8
  - NUMPY=1.8.2  SCIPY=0.13.3 NETCDF=1.1   MATPLOTLIB=1.3 BASEMAP=1.0.8 # Ubuntu 14.04
  - NUMPY=1.9    SCIPY=0.17   NETCDF=1.1   MATPLOTLIB=1.4 BASEMAP=1.0.8
  - NUMPY=1.10   SCIPY=0.17   NETCDF=1.2.1 MATPLOTLIB=1.4 BASEMAP=1.0.8
  - NUMPY=1.11   SCIPY=0.17   NETCDF=1.2.4 MATPLOTLIB=1.5 BASEMAP=1.0.8
  - NUMPY=1.12   SCIPY=0.19.0 NETCDF=1.2.7 MATPLOTLIB=1.5 BASEMAP=1.1.0
  - NUMPY=1.13   SCIPY=0.19   NETCDF=1.2.4 MATPLOTLIB=1.5 BASEMAP=1.1.0
  - NUMPY=1.13.3 SCIPY=1.0    NETCDF=1.3.0 MATPLOTLIB=2.0 BASEMAP=1.1.0 # Bleeding edge
matrix:
  fast_finish: true
  allow_failures:
    - env: NUMPY=1.7    SCIPY=0.11   NETCDF=1.0   MATPLOTLIB=1.3 BASEMAP=1.0.8
    - env: NUMPY=1.8.2  SCIPY=0.13.3 NETCDF=1.1   MATPLOTLIB=1.3 BASEMAP=1.0.8
cache:
  directories:
    - $HOME/download2
    - $HOME/download3
    - $HOME/miniconda2
    - $HOME/miniconda3
sudo: required
before_install:
  - if [ $TRAVIS_PYTHON_VERSION == 2.7 ]; then
        condaURL=https://repo.continuum.io/miniconda/Miniconda2-4.3.21-Linux-x86_64.sh;
        condabin=$HOME/miniconda2/bin;
        condapath=/home/travis/miniconda2/bin:$PATH;    
        download=/$HOME/download2;
    elif [ $TRAVIS_PYTHON_VERSION == 3.5 ]; then
        condaURL=https://repo.continuum.io/miniconda/Miniconda3-4.3.21-Linux-x86_64.sh;
        condabin=$HOME/miniconda3/bin;
        condapath=/home/travis/miniconda3/bin:$PATH;    
        download=/$HOME/download3;
    fi
  - if [ ! -e $condabin ]; then
        mkdir -p $download;
        cd $download;
        wget -c $condaURL -O miniconda.sh;
        chmod +x miniconda.sh;
        ./miniconda.sh -b -f;
        cd ..;
    fi
  - export PATH=$condapath
  - echo $PATH
  - echo $PYTHONPATH
install:
  - conda config --append channels conda-forge
  - conda install -q --yes python=$TRAVIS_PYTHON_VERSION
  - if [ ! -e $HOME/oillibrary ] && [ $TRAVIS_PYTHON_VERSION == 2.7 ]; then
        cd $HOME;
        mkdir -p oillibrary;
        cd oillibrary;
        git clone https://github.com/NOAA-ORR-ERD/OilLibrary.git;
        cd OilLibrary;
        conda install -q --yes -c conda-forge numpy=$NUMPY scipy=$SCIPY;
        conda install -q --yes -c conda-forge SQLAlchemy=1.1;
        conda install -q --yes -c noaa-orr-erd zope.sqlalchemy=0.7.7 awesome-slugify>=1.6.5;
        conda install -q --yes -c conda-forge pytest>=2.9.2;
        conda install -q --yes repoze.lru>=0.6;
        conda install -q --yes -c noaa-orr-erd unit_conversion>=2.5.4;
        conda install -q --yes setuptools_scm;
        python setup.py install;
    fi
  - conda config --get channels;
  - conda install -q --yes -c conda-forge future hdf4 numpy=$NUMPY scipy=$SCIPY matplotlib=$MATPLOTLIB netcdf4=$NETCDF configobj;
  - conda install -q --yes -c conda-forge coveralls basemap=$BASEMAP basemap-data-hires nomkl;
  - cd /home/travis/build/OpenDrift/opendrift;
script: coverage run -m unittest discover -s tests/
after_success:
  - coveralls
