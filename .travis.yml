language: python

python:
  - 3.7
  - 3.8

env:
  - NUMPY=1.19 SCIPY=1.5 NETCDF=1.5 MATPLOTLIB=3.3 XARRAY=0.16
  - NUMPY=1.19 SCIPY=1.5 NETCDF=1.5 MATPLOTLIB=3.3
  - VANILLA=1

services:
  - docker

matrix:
  fast_finish: true

before_install:
  - export DOCKERFILE="Dockerfile" CACHE_FROM="opendrift/opendrift:latest"

install:
  - pip install pyyaml coveralls
  - cd docker
  - docker build --pull --cache-from ${CACHE_FROM} -t opendrift:${TRAVIS_COMMIT} --file ${DOCKERFILE} ..
  - cd ..

script:
  - docker run -itd --name="opendrift_${TRAVIS_COMMIT}" opendrift:${TRAVIS_COMMIT}

  - if [ -n "$VANILLA" ]; then
      docker exec "opendrift_${TRAVIS_COMMIT}" bash -c ". ~/.bashrc && conda install -q --yes -c conda-forge numpy=${NUMPY} scipy=${SCIPY} netcdf4=${NETCDF} matplotlib=${MATPLOTLIB}"; fi

  - if [ -z "$VANILLA" ] && [ -n "$XARRAY" ]; then
      docker exec "opendrift_${TRAVIS_COMMIT}" bash -c ". ~/.bashrc && conda install -q --yes -c conda-forge xarray=$XARRAY dask";
    fi

  # Python 3 versions
  - if [ $TRAVIS_PYTHON_VERSION == 3.7 ]; then
      docker exec "opendrift_${TRAVIS_COMMIT}" bash -c ". ~/.bashrc && conda install -q --yes -c conda-forge python=3.7";
    fi

  - if [ $TRAVIS_PYTHON_VERSION == 3.8 ]; then
      docker exec "opendrift_${TRAVIS_COMMIT}" bash -c ". ~/.bashrc && conda install -q --yes -c conda-forge python=3.8";
    fi

  - docker exec "opendrift_${TRAVIS_COMMIT}" bash -c ". ~/.bashrc && conda list"
  - docker exec "opendrift_${TRAVIS_COMMIT}" bash -c ". ~/.bashrc && pytest --cov=opendrift --ignore=tests/benchmarks --ignore=tests/wps --runslow --durations=10 --benchmark-disable -v -s --log-cli-level=info"

after_success:
  - docker cp "opendrift_${TRAVIS_COMMIT}":/code/.coverage .
  - docker stop "opendrift_${TRAVIS_COMMIT}"
  - sed -e "s|\/code\/|${PWD}\/|g" -i .coverage
  - coveralls
